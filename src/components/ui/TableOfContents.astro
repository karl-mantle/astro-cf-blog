---
import type { MarkdownHeading } from 'astro';
import { Icon } from 'astro-icon/components';
import { getTableOfContents } from '~/utils/collections';
import TableOfContentsHeading from '~/components/ui/TableOfContentsHeading.astro';

const { headings } = Astro.props as { headings: MarkdownHeading[] };

const toc = getTableOfContents(headings);
---
<aside class="sticky top-0">  
  <nav
    id="toc"
    class="fixed md:absolute inset-0 md:left-auto md:-right-72 max-w-[calc(100vw-2rem)] md:max-w-56 hidden flex flex-col gap-2 p-4 m-4 md:m-0 h-fit md:h-[calc(100vh-3rem)] overflow-y-auto w-full bg-mikado-100 md:bg-transparent pointer-events-none transition duration-300"
    aria-hidden="true"
  >
    <div class="text-lg mb-2 border-b border-mikado-500 pb-1 w-fit">Table of contents:</div>
    <ul>
      {toc.map((heading) => <TableOfContentsHeading heading={heading} />)}
    </ul>
    <button
      id="toc-close-btn"
      class="flex gap-2 justify-center items-center p-2 xl:mx-auto xl:w-fit text-sm border-b border-transparent xl:hover:border-mikado-950 focus-visible:bg-mikado-300 focus-visible:text-black focus:border-b-2 focus-visible:border-black cursor-pointer transition duration-300"
      aria-label="close table of contents"
      aria-pressed="false"
    >
      <Icon name="ri:close-line" height={24} width={24} />
      <span>Close</span>
    </button>
  </nav>
</aside> 

<script>
  // @ts-nocheck
  function initToc() {
    const toc = document.getElementById('toc');
    const btnWrapper = document.getElementById('toc-btn-wrapper');
    const toggleBtn = document.getElementById('toc-toggle-btn');
    const closeBtn = document.getElementById('toc-close-btn');

    // maybe this should be global, so toc persists between different posts?
    let tocOpen = false;

    // TODO: add focus trap from search, perhaps a shared module??

    function updateToc() {
      if (tocOpen) {
        toc?.classList.remove('opacity-0', 'hidden', 'pointer-events-none');
        toc?.removeAttribute('inert');
        toc?.setAttribute('aria-hidden', 'false');
        btnWrapper?.classList.add('opacity-0', 'hidden', 'pointer-events-none');
        toggleBtn?.setAttribute('aria-pressed', 'true');
        toggleBtn?.setAttribute('inert', '');
      } else {
        toc?.classList.add('opacity-0', 'hidden', 'pointer-events-none');
        toc?.setAttribute('inert', '');
        toc?.setAttribute('aria-hidden', 'true');
        btnWrapper?.classList.remove('opacity-0', 'hidden', 'pointer-events-none');
        toggleBtn?.setAttribute('aria-pressed', 'false');
        toggleBtn?.removeAttribute('inert');
      }
    }

    updateToc();

    toggleBtn?.addEventListener('click', () => {
      tocOpen = !tocOpen;
      updateToc();
    });

    closeBtn?.addEventListener('click', () => {
      tocOpen = false;
      updateToc();
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        tocOpen = false;
        updateToc();
      }
    });

    toc?.addEventListener('focusin', () => {
      if (!tocOpen) {
        tocOpen = true;
        updateToc();
      }
    });
  };
  document.addEventListener('DOMContentLoaded', initToc);
  document.addEventListener('astro:after-swap', initToc);
</script>
