---
import type { HTMLAttributes } from "astro/types";
import { Icon } from "astro-icon/components";

interface Props extends HTMLAttributes<"form"> {
  accessKey: string;
  siteKey: string;
}

const { accessKey, siteKey, class: className, ...rest }: Props = Astro.props;
---

<form
  id="form"
  method="POST"
  data-form
  class:list={["grid w-full grid-cols-1 gap-2 md:grid-cols-2", className]}
  {...rest}
>
  <input type="hidden" name="access_key" value={accessKey} />

  {siteKey && <input type="hidden" name="captcha" value="turnstile" />}

  <input type="text" name="website" class="hidden" tabindex="-1" autocomplete="off" />

  <div class="flex flex-col gap-2">
    <label for="name">Name</label>
    <input id="name" type="text" name="name" required />
  </div>

  <div class="flex flex-col gap-2">
    <label for="email">Email</label>
    <input id="email" type="email" name="email" required />
  </div>

  <div class="flex flex-col gap-2 md:col-span-2">
    <label for="subject">Subject</label>
    <input id="subject" type="text" name="subject" required />
  </div>

  <div class="col-span-1 flex flex-col gap-2 md:col-span-2">
    <label for="message">Message</label>
    <textarea id="message" name="message" required class="min-h-40"></textarea>
  </div>

  {siteKey && <div class="cf-turnstile mt-4 min-h-18 md:col-span-2" data-sitekey={siteKey} />}

  <div class="flex md:col-span-2">
    <button
      type="submit"
      class="group/btn hover:border-mikado-950 focus-visible:bg-focus-color hover:text-mikado-950 flex w-fit cursor-pointer items-center justify-center gap-2 border-b-2 border-transparent p-1 font-medium transition-colors duration-300 focus-visible:border-black focus-visible:text-black dark:hover:border-white dark:hover:text-white"
    >
      <span class="font-medium">Submit</span>
      <Icon name="material-symbols:arrow-right-alt" height={26} width={26} class="w-8" />
    </button>
  </div>

  <div id="feedback" class="md:col-span-2" role="alert" aria-live="polite" aria-atomic="true"></div>
</form>

{siteKey && <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer />}

<script>
  function initContactForm() {
    const form = document.getElementById("form") as HTMLFormElement;
    const feedback = document.getElementById("feedback");

    if (!form || !feedback) return;

    form.addEventListener("submit", function (e) {
      const formData = new FormData(form);
      e.preventDefault();

      const object = Object.fromEntries(formData);
      const json = JSON.stringify(object);

      feedback.innerHTML = "Please wait...";

      fetch("https://api.web3forms.com/submit", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Accept: "application/json",
        },
        body: json,
      })
        .then(async (response) => {
          const json = await response.json();
          if (response.status == 200) {
            feedback.innerHTML = json.message;
          } else {
            console.log(response);
            feedback.innerHTML = json.message;
          }
        })
        .catch((error) => {
          console.log(error);
          feedback.innerHTML = "Something went wrong!";
        })
        .then(function () {
          form.reset();
          setTimeout(() => {
            feedback.style.display = "none";
          }, 3000);
        });
    });
  }

  document.addEventListener("astro:page-load", initContactForm);
</script>
